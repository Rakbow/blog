<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Franchise Detail</title>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width,initial-scale=1.0"/>

    <!-- bootstrap -->
    <link rel="stylesheet" th:href="@{/css/bootstrap/myBootstrap.min.css}">
    <script th:src="@{/tool/bootstrap/bootstrap.min.js}"></script>

    <link href="https://img.rakbow.com/common/favicon.ico" type="image/x-icon" rel="shortcut icon"/>
    <link th:href="@{/css/iconfont/iconfont.css}" rel="stylesheet" />

    <!-- PrimeVue -->
    <!--    <link th:href="@{/css/primevue/themes/lara-light-blue/theme.css}" rel="stylesheet"/>-->
    <!--        <link th:href="@{/css/primevue/themes/bootstrap4-light-blue/theme.css}" rel="stylesheet"/>-->
    <link th:href="@{/css/primevue/themes/bootstrap4-dark-blue/theme.css}" rel="stylesheet"/>
    <link th:href="@{/css/primevue/primevue.min.css}" rel="stylesheet"/>
    <link th:href="@{/css/primeflex/primeflex.min.css}" rel="stylesheet"/>
    <link th:href="@{/css/primeicons/primeicons.css}" rel="stylesheet"/>

    <!-- Vue3 -->
    <script th:src="@{/js/vue/vue.global.js}"></script>
    <script th:src="@{/js/primevue/primevue.min.js}"></script>
    <script th:src="@{/js/vue/vue-router.global.js}"></script>

    <!-- PrimeVue Components -->
    <script th:src="@{/js/primevue/components/fileupload.min.js}"></script>
    <script th:src="@{/js/primevue/components/panel.min.js}"></script>
    <script th:src="@{/js/primevue/components/divider.min.js}"></script>
    <script th:src="@{/js/primevue/components/dialog.min.js}"></script>
    <script th:src="@{/js/primevue/components/fieldset.min.js}"></script>
    <script th:src="@{/js/primevue/components/chips.min.js}"></script>
    <script th:src="@{/js/primevue/components/inputtext.min.js}"></script>
    <script th:src="@{/js/primevue/components/multiselect.min.js}"></script>
    <script th:src="@{/js/primevue/components/galleria.min.js}"></script>
    <script th:src="@{/js/primevue/components/menubar.min.js}"></script>
    <script th:src="@{/js/primevue/components/avatar.min.js}"></script>
    <script th:src="@{/js/primevue/components/toast.min.js}"></script>
    <script th:src="@{/js/primevue/components/toastservice.min.js}"></script>
    <script th:src="@{/js/primevue/components/textarea.min.js}"></script>
    <script th:src="@{/js/primevue/components/calendar.min.js}"></script>
    <script th:src="@{/js/primevue/components/inputnumber.min.js}"></script>
    <script th:src="@{/js/primevue/components/inputswitch.min.js}"></script>
    <script th:src="@{/js/primevue/components/splitbutton.min.js}"></script>
    <script th:src="@{/js/primevue/components/datatable.min.js}"></script>
    <script th:src="@{/js/primevue/components/column.min.js}"></script>
    <script th:src="@{/js/primevue/components/contextmenu.min.js}"></script>
    <script th:src="@{/js/primevue/components/inplace.min.js}"></script>
    <script th:src="@{/js/primevue/components/blockui.min.js}"></script>
    <script th:src="@{/js/primevue/components/card.min.js}"></script>

    <script th:src="@{/js/primevue/components/scrolltop.min.js}"></script>
    <script th:src="@{/js/primevue/components/scrollpanel.min.js}"></script>
    <script th:src="@{/js/primevue/components/dynamicdialog.min.js}"></script>
    <script th:src="@{/js/primevue/components/dialogservice.min.js}"></script>
    <script th:src="@{/js/primevue/components/divider.min.js}"></script>
    <script th:src="@{/js/primevue/components/chip.min.js}"></script>
    <script th:src="@{/js/primevue/components/menubar.min.js}"></script>
    <script th:src="@{/js/primevue/components/avatar.min.js}"></script>
    <script th:src="@{/js/primevue/components/tag.min.js}"></script>

    <!-- Axios -->
    <script th:src="@{/tool/axios/axios.js}"></script>

    <!-- Jquery -->
    <script th:src="@{/js/jquery.js}"></script>

    <!-- high light js -->
    <link th:href="@{/tool/highlight/default.min.css}" rel="stylesheet">
    <script th:src="@{/tool/highlight/highlight.min.js}"></script>

    <!-- md-editor-v3 -->
    <script th:src="@{/tool/md-editor-v3/md-editor-v3.umd.js}"></script>
    <link th:href="@{/tool/md-editor-v3/style.css}" rel="stylesheet">

    <!-- marked -->
    <script th:src="@{/js/marked.min.js}"></script>
    <link th:href="@{/css/github-markdown/github-markdown.css}" rel="stylesheet" />

    <script th:src="@{/js/clipboard.js}"></script>

    <!-- basic js -->
    <script th:src="@{/js/basic/Data_Helper.js}"></script>
    <script th:src="@{/js/basic/Http_Request.js}"></script>
    <script th:src="@{/js/basic/Rakbow_Web_Helper_Str.js}"></script>
    <script th:src="@{/js/basic/Rakbow_Web_Exception_Str_CN.js}"></script>
    <script th:src="@{/js/basic/Search_Params.js}"></script>
    <script th:src="@{/js/basic/Item_Detail_Image_Params.js}"></script>
    <script th:src="@{/js/basic/Item_Detail_Text_Params.js}"></script>

    <!--other css -->
    <link th:href="@{/css/global.css}" rel="stylesheet"/>
    <link th:href="@{/css/search.css}" rel="stylesheet"/>
    <link th:href="@{/css/product-category.css}" rel="stylesheet"/>
    <link th:href="@{/css/item-detail.css}" rel="stylesheet"/>
</head>
<body>
<div id="app">
    <!-- 头部 -->
    <header class="sticky-top mb-2" th:insert="~{template/header :: site_header}"></header>

    <div id="main" class="grid mt-2">
        <p-toast></p-toast>
        <div class="col-12 sm:col-12 md:col-9 lg:col-7 lg:col-offset-1">
            <p-card style="min-height: 100%">
                <template #title>
                    <div class="grid">
                        <div class="col-9 text-start">
                            <h3 class="ml-2 mt-0 mb-0" style="text-align: left">
                                <b class="detail-item-title">{{franchise.name}}</b>
                                <span style="font-size: 13px" class="label">(系列)</span>
                            </h3>
                        </div>
                        <div class="col-2 text-end p-0 m-0" th:if="${loginUser != null}">
                            <p-splitbutton :model="edits" class="p-button-sm bg-primary"
                                           th:if="${loginUser.type == 1}">
                                <p-button @click="openEditDialog">
                                    <i class="pi pi-cog"></i>
                                </p-button>
                            </p-splitbutton>
                        </div>
                    </div>
                </template>
                <template #subtitle>
                    <h5 v-if="franchise.nameEn != ''" class="text-start ml-2 mt-0 mb-0 detail-item-subtitle"
                        style="text-align: left"><small>{{franchise.nameEn}}</small>
                    </h5>
                    <h5 v-if="franchise.nameZh != ''" class="text-start ml-2 mt-0 mb-0 detail-item-subtitle"
                        style="text-align: left"><small>{{franchise.nameZh}}</small></h5>
                </template>
                <template #content>
                    <p-card v-if="franchise.parentFranchise">
                        <template #title>
                            父系列
                        </template>
                        <template #content>
                            <a :href="'/db/franchise/' + franchise.parentFranchise.id">
                                <span>{{franchise.parentFranchise.name}}</span>
                            </a>
                        </template>
                    </p-card>
                    <!-- products -->
                    <p-fieldset :toggleable="true" class="mt-2" v-if="!franchise.metaLabel">
                        <template #legend>
                            <i class="pi iconfont icon-_classification"></i>
                            <b>作品</b>
                        </template>
                        <div class="grid ml-4" v-if="products != 0">
                            <table class="table product-table table-sm table-borderless a_with_underline">
                                <thead>
                                <tr>
                                    <th scope="col" class="text-start detail-item-table-title">日&nbsp期</th>
                                    <th scope="col" class="text-start detail-item-table-title">作&nbsp品</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr v-for="product in products">
                                    <td width="80px" class="label">{{product.releaseDate}}</td>
                                    <td>
                                        <a :href="'/db/product/' + product.id">
                                            <span :class="'rakbow-product-category-' + product.category.id">
                                                {{product.name}}
                                            </span>
                                        </a> <span class="label">({{product.category.nameZh}})</span>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div v-else>
                            <span class="emptyInfo"><em>暂无作品</em></span>
                        </div>
                    </p-fieldset>
                    <!-- child franchises -->
                    <p-fieldset :toggleable="true" class="mt-2" v-else>
                        <template #legend>
                            <i class="pi iconfont icon-_classification"></i>
                            <b>子系列</b>
                        </template>
                        <div class="grid ml-4 mt-2" v-if="franchise.childFranchiseInfos.length != 0">
                            <table class="table product-table table-sm table-borderless a_with_underline">
                                <tbody>
                                    <tr v-for="childFranchise in franchise.childFranchiseInfos">
                                        <td>
                                            <a :href="'/db/franchise/' + childFranchise.id">
                                                <span>{{childFranchise.name}}</span>
                                            </a>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div v-else>
                            <span class="emptyInfo"><em>暂无子系列</em></span>
                        </div>
                    </p-fieldset>
                    <!-- description -->
                    <div th:insert="~{template/item-detail-template :: description_field_set}"></div>
                </template>
            </p-card>
        </div>
        <div class="col-12 sm:col-12 md:col-3 lg:col-3">
            <div th:insert="~{template/item-detail-template :: sider_image_panel}"></div>
            <div th:insert="~{template/item-detail-template :: page_info_card}"></div>
        </div>
    </div>
    <p-dialog :modal="true" v-model:visible="displayEditDialog" header="编辑基础信息"
              :style="{width: '600px'}" class="p-fluid">
        <p-blockui :blocked="editBlock">
            <div class="formgrid grid">
                <div class="field col">
                    <label>名称<span style="color: red">*</span></label>
                    <p-inputtext v-model.trim="franchiseEdit.name"></p-inputtext>
                </div>
                <div class="field col">
                    <label>名称(中)<span style="color: red">*</span></label>
                    <p-inputtext v-model.trim="franchiseEdit.nameZh"></p-inputtext>
                </div>
            </div>
            <div class="formgrid grid">
                <div class="field col">
                    <label>名称(英)</label>
                    <p-inputtext v-model.trim="franchiseEdit.nameEn"></p-inputtext>
                </div>
                <div class="field col">
                    <label>发售时间<span style="color: red">*</span></label>
                    <p-calendar v-model="franchiseEdit.originDate" date-format="yy/mm/dd"
                                :show-button-bar="true"
                                :show-icon="true"></p-calendar>
                </div>
            </div>
            <div class="field">
                <label>备注</label>
                <p-textarea v-model="franchiseEdit.remark" rows="3" cols="20"
                            :auto-resize="true"></p-textarea>
            </div>
            <div class="field" v-if="franchiseEdit.metaLabel">
                <label class="mb-3">子系列</label>
                <p-multiselect v-model="franchiseEdit.childFranchises" :options="franchiseSet" placeholder="子系列"
                               option-label="label" option-value="value" display="chip" :filter="true">
                </p-multiselect>
            </div>
        </p-blockui>
        <template #footer>
            <p-button label="取消" icon="pi pi-times" class="p-button-text"
                      @click="closeEditDialog" :disabled="editBlock"></p-button>
            <p-button label="保存" icon="pi pi-check" class="p-button-text"
                      @click="submitEditFranchise" :disabled="editBlock"></p-button>
        </template>
    </p-dialog>

    <p-dynamicdialog></p-dynamicdialog>
    <!-- 尾部 -->
    <footer th:insert="~{template/footer :: site_footer}"></footer>
</div>
<script type="module" th:inline="javascript">

    const {createApp, onMounted, ref} = Vue;
    const Tooltip = primevue.tooltip;
    const { useDialog } = primevue.usedialog;
    const {useToast} = primevue.usetoast;

    const App = {
        setup() {
            onMounted(() => {
                init();
                $(window).resize(function () {
                    $("#main").attr("style", "min-height:" + ($(window).height() - 350) + 'px');
                });
            })

            //region common header
            const dialog = useDialog();
            const openSearchPanel = () => {
                showSearchPanel(dialog);
            }
            //endregion

            //region image
            const activeIndex = ref(0)
            const displayCustom = ref(false)
            const imageClick = (index) => {
                activeIndex.value = index;
                displayCustom.value = true;
            };
            //endregion

            //region basic
            const franchise = ref([[${franchise}]]);
            const franchiseSet = ref([[${franchiseSet}]]);
            const toast = useToast();
            const detailInfo = ref([[${detailInfo}]]);
            const itemImageInfo = ref([[${itemImageInfo}]]);
            const pageInfo = ref([[${pageInfo}]]);
            const products = ref([[${products}]]);
            //endregion

            //region edit basic info
            const edits = ref([
                {
                    label: '图片管理',
                    icon: 'pi pi-images',
                    command: () => {
                        openImageEditDialog();
                    }
                },
                {
                    label: '描述信息',
                    icon: 'pi iconfont icon-miaoshu',
                    command: () => {
                        openDescriptionEditDialog();
                    }
                }
            ]);
            const editBlock = ref(false);
            const franchiseEdit = ref({});
            const displayEditDialog = ref(false);

            //打开编辑数据面板
            const openEditDialog = () => {
                axiosGetRequest(CHECK_USER_AUTHORITY_URL, null)
                    .then(res => {
                        if (res.state === 0) {
                            toast.add({severity: 'error', summary: 'Error', detail: res.message, life: 3000});
                        } else {
                            franchiseEdit.value = JSON.parse(JSON.stringify(franchise.value));
                            displayEditDialog.value = true;
                        }
                    })
            };
            const openDescriptionEditDialog = () => {
                axiosGetRequest(CHECK_USER_AUTHORITY_URL, null)
                    .then(res => {
                        if (res.state === 0) {
                            toast.add({severity: 'error', summary: 'Error', detail: res.message, life: 3000});
                        } else {
                            showDescriptionEditDialog(toast, dialog, detailInfo.value);
                        }
                    });
            };
            const openImageEditDialog = () => {
                axiosGetRequest(CHECK_USER_AUTHORITY_URL, null)
                    .then(res => {
                        if (res.state === 0) {
                            toast.add({severity: 'error', summary: 'Error', detail: res.message, life: 3000});
                        } else {
                            showImageEditDialog(toast, dialog, itemImageInfo.value, detailInfo.value);
                        }
                    })
            };

            //关闭编辑数据面板
            const closeEditDialog = () => {
                displayEditDialog.value = false;
                franchiseEdit.value = {};
            };

            //保存编辑数据
            const submitEditFranchise = () => {
                editBlock.value = true;
                axiosPostRequest(UPDATE_FRANCHISE_URL, franchiseEdit.value)
                    .then(res => {
                        if (res.state === 1) {
                            franchiseEdit.value = {};
                            toast.add({
                                severity: 'success',
                                summary: 'Successful',
                                detail: res.message,
                                life: 3000
                            });
                            closeEditDialog();
                            location.reload(true);
                        } else {
                            editBlock.value = false;
                            toast.add({severity: 'error', summary: 'Error', detail: res.message, life: 3000});
                        }
                    })
                    .catch(error => {
                        console.error(error);
                    });
            };
            //endregion

            //region init
            const init = () => {
                console.log(franchise.value)
                $("#main").attr("style", "min-height:" + ($(window).height() - 350) + 'px');
                text2marked();
            };
            const text2marked = () => {
                if (detailInfo.value.description != null && detailInfo.value.description !== "") {
                    document.getElementById("description").innerHTML = marked.parse(detailInfo.value.description);
                }
            };
            //endregion

            return {
                //header
                dialog, openSearchPanel, NOT_LOGIN_NAVBAR_ITEMS, LOGIN_NAVBAR_ITEMS,

                //image
                activeIndex, displayCustom, imageClick, initGalleriaImageClass,

                //basic
                franchise, detailInfo, itemImageInfo, pageInfo, responsiveOptions, products, franchiseSet,

                //edit
                editBlock, franchiseEdit, edits, displayEditDialog, openEditDialog, closeEditDialog, submitEditFranchise,
            }
        },
        components: {
            "p-panel": primevue.panel,
            "p-fieldset": primevue.fieldset,
            "p-button": primevue.button,
            "p-dialog": primevue.dialog,
            "p-fileupload": primevue.fileupload,
            "p-chips": primevue.chips,
            "p-divider": primevue.divider,
            "p-inputtext": primevue.inputtext,
            "p-multiselect": primevue.multiselect,
            "p-galleria": primevue.galleria,
            "p-menubar": primevue.menubar,
            "p-avatar": primevue.avatar,
            "p-toast": primevue.toast,
            "p-dropdown": primevue.dropdown,
            "p-textarea": primevue.textarea,
            "p-calendar": primevue.calendar,
            "p-inputnumber": primevue.inputnumber,
            "p-inputswitch": primevue.inputswitch,
            "p-splitbutton": primevue.splitbutton,
            "p-datatable": primevue.datatable,
            "p-column": primevue.column,
            "p-contextmenu": primevue.contextmenu,
            "p-inplace": primevue.inplace,
            "p-blockui": primevue.blockui,
            "p-card": primevue.card,

            "p-chip": primevue.chip,
            "p-tag": primevue.tag,
            "p-scrollpanel": primevue.scrollpanel,
            "p-scrolltop": primevue.scrolltop,
            "p-paginator": primevue.paginator,
            "p-dynamicdialog": primevue.dynamicdialog,
        }
    };

    const routes = [{path: "/", component: App}];

    const router = VueRouter.createRouter({
        // history: VueRouter.createWebHashHistory(),
        history: VueRouter.createWebHistory(),
        routes
    });

    createApp(App)
        .use(router)
        .use(primevue.toastservice)
        .use(primevue.config.default)
        .use(MdEditorV3)
        .directive('tooltip', Tooltip)
        .use(primevue.dialogservice)
        .mount("#app");
</script>
<style>
    .image-cover {
        position: absolute;
        top: 50%;
        left: 50%;
        display: block;
        transform: translate(-50%, -50%);
        cursor: pointer;
        pointer-events: none;
    }









    .custom-galleria-footer {
        display: flex;
        align-items: center;
        /*background-color: rgba(0, 0, 0, 0.9);*/
        color: #ffffff;
    }

    .custom-galleria-footer > button {
        background-color: transparent;
        color: #ffffff;
        border: 0 none;
        border-radius: 0;
        margin: .2rem 0;
    }

    .custom-galleria-footer > button.fullscreen-button {
        margin-left: auto;
    }

    .custom-galleria-footer > button:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }

    .title-container > span {
        font-size: .9rem;
        padding-left: .829rem;
    }

    .title-container > span.title {
        font-weight: bold;
    }

    .p-galleria-content {
        position: relative;
    }

    .p-galleria-thumbnail-content {
        height: 100px;
        width: 100px;
    }



    /*.p-panel .p-panel-content {*/
    /*    background-color: #343e4c;*/
    /*}*/

    /*.p-field .p-fieldset-content {*/
    /*    background-color: #343e4c;*/
    /*}*/



    b.rbot {
        background-position: 0 -8px;
    }

    .p-panel .p-panel-content {
        padding: 0.5rem;
    }
</style>
</body>
</html>