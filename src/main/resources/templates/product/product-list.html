<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Product List</title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />

    <link href="https://img.rakbow.com/common/favicon.ico" type="image/x-icon" rel="shortcut icon" />
    <link th:href="@{/css/iconfont/iconfont.css}" rel="stylesheet" type="text/css" />

    <!-- bootstrap -->
    <link rel="stylesheet" th:href="@{/css/bootstrap/myBootstrap.min.css}">
    <script th:src="@{/tool/bootstrap/bootstrap.min.js}"></script>


    <!-- PrimeVue css-->
    <link th:href="@{/css/primevue/themes/bootstrap4-dark-blue/theme.css}" rel="stylesheet"/>
    <link th:href="@{/css/primevue/primevue.min.css}" rel="stylesheet" />
    <link th:href="@{/css/primeflex/primeflex.min.css}" rel="stylesheet" />
    <link th:href="@{/css/primeicons/primeicons.css}" rel="stylesheet" />

    <!-- Vue3 -->
    <script th:src="@{/js/vue/vue.global.js}"></script>
    <script th:src="@{/js/primevue/primevue.min.js}"></script>
    <script th:src="@{/js/vue/vue-router.global.js}"></script>

    <!-- PrimeVue Components -->
    <script th:src="@{/js/primevue/components/menubar.min.js}"></script>
    <script th:src="@{/js/primevue/components/avatar.min.js}"></script>
    <script th:src="@{/js/primevue/components/inputtext.min.js}"></script>
    <script th:src="@{/js/primevue/components/toast.min.js}"></script>
    <script th:src="@{/js/primevue/components/toastservice.min.js}"></script>
    <script th:src="@{/js/primevue/components/datatable.min.js}"></script>
    <script th:src="@{/js/primevue/components/column.min.js}"></script>
    <script th:src="@{/js/primevue/components/multiselect.min.js}"></script>
    <script th:src="@{/js/primevue/components/toolbar.min.js}"></script>
    <script th:src="@{/js/primevue/components/calendar.min.js}"></script>
    <script th:src="@{/js/primevue/components/panel.min.js}"></script>
    <script th:src="@{/js/primevue/components/textarea.min.js}"></script>
    <script th:src="@{/js/primevue/components/divider.min.js}"></script>
    <script th:src="@{/js/primevue/components/dialog.min.js}"></script>

    <script th:src="@{/js/primevue/components/scrolltop.min.js}"></script>
    <script th:src="@{/js/primevue/components/scrollpanel.min.js}"></script>
    <script th:src="@{/js/primevue/components/dynamicdialog.min.js}"></script>
    <script th:src="@{/js/primevue/components/dialogservice.min.js}"></script>
    <script th:src="@{/js/primevue/components/divider.min.js}"></script>
    <script th:src="@{/js/primevue/components/chip.min.js}"></script>
    <script th:src="@{/js/primevue/components/menubar.min.js}"></script>
    <script th:src="@{/js/primevue/components/avatar.min.js}"></script>
    <script th:src="@{/js/primevue/components/tag.min.js}"></script>

    <!-- Axios -->
    <script th:src="@{/tool/axios/axios.js}"></script>

    <!-- Jquery -->
    <script th:src="@{/js/jquery.js}"></script>

    <!-- basic js -->
    <script th:src="@{/js/basic/Data_Helper.js}"></script>
    <script th:src="@{/js/basic/Http_Request.js}"></script>
    <script th:src="@{/js/basic/Rakbow_Web_Helper_Str.js}"></script>
    <script th:src="@{/js/basic/Rakbow_Web_Exception_Str_CN.js}"></script>
    <script th:src="@{/js/basic/Search_Params.js}"></script>

    <!--other css -->
    <link th:href="@{/css/global.css}" rel="stylesheet"/>
    <link th:href="@{/css/search.css}" rel="stylesheet"/>
    <link th:href="@{/css/item-list.css}" rel="stylesheet"/>
</head>
<body>
<div id="app">
    <!-- 头部 -->
    <header class="sticky-top mb-2" th:insert="~{template/header :: site_header}"></header>

    <p-toast></p-toast>
    <p-toolbar class="mb-4">
        <template #start>
            <p-button label="新增" icon="pi pi-plus" class="p-button-success mr-4"
                      @click="openNewDialog"></p-button>&nbsp;
        </template>
        <template #end>
            <p-button label="导出(CSV)" icon="pi pi-external-link" class="p-button-help"
                      @click="exportCSV($event)"></p-button>
        </template>
    </p-toolbar>
    <p-datatable ref="dt" :value="products" class=" p-datatable-sm"
                 :lazy="true" v-model:filters="filters" :total-records="totalRecords" :loading="loading"
                 @page="onPage($event)" @sort="onSort($event)" @filter="onFilter($event)"
                 filter-display="row" :globalFilterFields="['name','nameZh']" dataKey="id"
                 :paginator="true" :rows="10" striped-rows :resizable-columns="true" column-resize-mode="expand"
                 :scrollable="true" scroll-height="flex" :rows-per-page-options="[10,25,50]" show-gridlines
                 paginator-template="FirstPageLink PrevPageLink PageLinks NextPageLink
                             LastPageLink CurrentPageReport RowsPerPageDropdown"
                 current-page-report-template="当前显示第【{first}】至【{last}】条数据，总【{totalRecords}】条数据"
                 responsive-layout="scroll">
        <template #header>
            <div class="grid p-fluid">
                <div class="col-12 lg:col-3 md:col-3 sm:col-6" style="text-align:left">
                    <p-multiselect :model-value="selectedColumns" :options="columns" option-label="header"
                                   @update:model-value="onToggle"
                                   placeholder="可选显示列" style="width: 20em"></p-multiselect>
                </div>
            </div>
        </template>
        <template #empty>
                    <span class="emptyInfo">
                        未检索到符合条件的数据
                    </span>
        </template>
        <template #loading>
            加载中，别急~
        </template>
        <p-column style="flex: 0 0 4rem">
            <template #body="slotProps">
                <p-button icon="pi pi-pencil" class="p-button-rounded p-button-text"
                          @click="openEditDialog(slotProps.data)"></p-button>
            </template>
        </p-column>
        <p-column header="Id" field="id" exportHeader="Product Id" :sortable="true" style="flex: 0 0 4rem"></p-column>
        <!--                <p-column header="封面" style="flex: 0 0 16rem">-->
        <!--                    <template #body="slotProps">-->
        <!--                        <img :src="slotProps.data.cover.url" :alt="slotProps.data.name" class="product-image" />-->
        <!--                    </template>-->
        <!--                </p-column>-->
        <p-column header="作品原名" field="name" :show-filter-menu="false" style="flex: 0 0 20rem">
            <template #body="slotProps">
                <a :href="'/db/product/' + slotProps.data.id">
                    {{slotProps.data.name}}
                </a>
            </template>
            <template #filter="{filterModel,filterCallback}">
                <p-inputtext type="text" v-model="filterModel.value" @keydown.enter="filterCallback()"></p-inputtext>
            </template>
        </p-column>
        <p-column header="作品名称(中)" field="nameZh" :show-filter-menu="false" style="flex: 0 0 15rem">
            <template #filter="{filterModel,filterCallback}">
                <p-inputtext type="text" v-model="filterModel.value" @keydown.enter="filterCallback()"></p-inputtext>
            </template>
        </p-column>
        <p-column header="发行时间" field="releaseDate" :sortable="true" style="flex: 0 0 7rem"></p-column>
        <p-column header="作品分类" field="category" :show-filter-menu="false" style="flex: 0 0 9rem">
            <template #body="slotProps">
                {{slotProps.data.category.nameZh}}
            </template>
            <template #filter="{filterModel,filterCallback}">
                <p-multiselect v-model="filterModel.value" @change="filterCallback()"
                               :options="productCategorySet" option-label="label" option-value="value"
                               display="chip" :filter="true">
                </p-multiselect>
            </template>
        </p-column>
        <p-column header="所属系列" field="franchise" :show-filter-menu="false" style="flex: 0 0 10rem">
            <template #body="slotProps">
                <a :href="'/db/franchise/' + slotProps.data.franchise.value">
                    {{slotProps.data.franchise.label}}
                </a>
            </template>
            <template #filter="{filterModel,filterCallback}">
                <p-multiselect v-model="filterModel.value" @change="filterCallback()"
                               :options="franchiseSet" placeholder="所属系列"
                               option-label="label" option-value="value" display="chip" :filter="true"
                               style="width: 9rem">
                </p-multiselect>
            </template>
        </p-column>
        <p-column v-for="(col, index) of selectedColumns" :field="col.field"
                  :header="col.header" :key="col.field + '_' + index">
        </p-column>
    </p-datatable>
    <p-dialog :modal="true" v-model:visible="displayNewDialog" :style="{width: '600px'}" header="新增数据"
              class="p-fluid">
        <p-panel header="基础信息">
            <div class="formgrid grid">
                <div class="field col">
                    <label>作品名称<span style="color: red">*</span></label>
                    <p-inputtext v-model.trim="product.name"></p-inputtext>
                </div>
                <div class="field col">
                    <label>作品名称(中文)<span style="color: red">*</span></label>
                    <p-inputtext v-model.trim="product.nameZh"></p-inputtext>
                </div>
            </div>
            <div class="formgrid grid">
                <div class="field col">
                    <label>作品名称(英语)</label>
                    <p-inputtext v-model.trim="product.nameEn"></p-inputtext>
                </div>
                <div class="field col">
                    <label>发行时间<span style="color: red">*</span></label>
                    <p-calendar v-model="product.releaseDate" date-format="yy/mm/dd"
                                :show-button-bar="true" :show-icon="true"></p-calendar>
                </div>
            </div>
            <div class="formgrid grid">
                <div class="field col">
                    <label class="mb-3">作品分类<span style="color: red">*</span></label>
                    <p-dropdown v-model="product.category" :options="productCategorySet"
                                placeholder="选择作品分类" option-label="label" option-value="value">
                    </p-dropdown>

                </div>
                <div class="field col">
                    <label class="mb-3">所属系列<span style="color: red">*</span></label>
                    <p-dropdown v-model="product.franchise" :options="franchiseSet"
                                placeholder="选择所属系列" option-label="label" option-value="value">
                    </p-dropdown>
                </div>
            </div>
            <div class="field">
                <label>备注</label>
                <p-textarea v-model="product.remark" rows="3" cols="20" :auto-resize="true"></p-textarea>
            </div>
        </p-panel>
        <p-panel header="其他信息">
            <p-divider align="center" type="dashed"><b>图片</b></p-divider>
            <div class="field">
                <span style="text-align: center"><em>如需添加图片，请到作品详情页面进行</em></span>
            </div>
            <p-divider align="center" type="dashed"><b>描述</b></p-divider>
            <div class="field">
                <span style="text-align: center"><em>如需图片描述信息，请到作品详情页面进行</em></span>
            </div>
        </p-panel>
        <template #footer>
            <p-button label="取消" icon="pi pi-times" class="p-button-text" @click="closeNewDialog"></p-button>
            <p-button label="保存" icon="pi pi-check" class="p-button-text" @click="submitNewProduct"></p-button>
        </template>
    </p-dialog>
    <p-dialog :modal="true" v-model:visible="displayEditDialog" :style="{width: '600px'}" header="编辑数据"
              class="p-fluid">
        <p-panel header="基础信息">
            <div class="formgrid grid">
                <div class="field col">
                    <label>作品名称<span style="color: red">*</span></label>
                    <p-inputtext v-model.trim="productEdit.name"></p-inputtext>
                </div>
                <div class="field col">
                    <label>作品名称(中文)<span style="color: red">*</span></label>
                    <p-inputtext v-model.trim="productEdit.nameZh"></p-inputtext>
                </div>
            </div>
            <div class="formgrid grid">
                <div class="field col">
                    <label>作品名称(英语)</label>
                    <p-inputtext v-model.trim="productEdit.nameEn"></p-inputtext>
                </div>
                <div class="field col">
                    <label>发行时间<span style="color: red">*</span></label>
                    <p-calendar v-model="productEdit.releaseDate" date-format="yy/mm/dd"
                                :show-button-bar="true" :show-icon="true"></p-calendar>
                </div>
            </div>
            <div class="formgrid grid">
                <div class="field col">
                    <label class="mb-3">作品分类<span style="color: red">*</span></label>
                    <p-dropdown v-model="productEdit.category" :options="productCategorySet"
                                placeholder="选择作品分类" option-label="label" option-value="value">
                    </p-dropdown>

                </div>
                <div class="field col">
                    <label class="mb-3">所属系列<span style="color: red">*</span></label>
                    <p-dropdown v-model="productEdit.franchise" :options="franchiseSet"
                                placeholder="选择所属系列" option-label="label" option-value="value">
                    </p-dropdown>
                </div>
            </div>
            <div class="field">
                <label>备注</label>
                <p-textarea v-model="productEdit.remark" rows="3" cols="20" :auto-resize="true"></p-textarea>
            </div>
        </p-panel>
        <p-panel header="其他信息">
            <p-divider align="center" type="dashed"><b>图片</b></p-divider>
            <div class="field">
                <span style="text-align: center"><em>如需添加图片，请到作品详情页面进行</em></span>
            </div>
            <p-divider align="center" type="dashed"><b>描述</b></p-divider>
            <div class="field">
                <span style="text-align: center"><em>如需图片描述信息，请到作品详情页面进行</em></span>
            </div>
        </p-panel>
        <template #footer>
            <p-button label="取消" icon="pi pi-times" class="p-button-text"
                      @click="closeEditDialog"></p-button>
            <p-button label="保存" icon="pi pi-check" class="p-button-text"
                      @click="submitEditProduct"></p-button>
        </template>
    </p-dialog>

    <p-dynamicdialog></p-dynamicdialog>
    <!-- 尾部 -->
    <footer class="mt-2" th:insert="~{template/footer :: site_footer}"></footer>
</div>
<script type="module" th:inline="javascript">
    const {createApp, onMounted, ref} = Vue;
    const {FilterMatchMode, FilterOperator} = primevue.api;
    const Tooltip = primevue.tooltip;
    const { useDialog } = primevue.usedialog;
    const {useToast} = primevue.usetoast;

    const App = {
        setup() {
            onMounted(() => {
                init();
            });

            //region ------基础------
            const products = ref([]);
            const franchiseSet = ref([[${franchiseSet}]]);
            const productCategorySet = ref([[${productCategorySet}]]);
            //endregion

            //region ------搜索------
            const totalRecords = ref(0);
            const queryParams = ref({});
            const onToggle = (val) => {
                selectedColumns.value = columns.value.filter(col => val.includes(col));
            };
            const columns = ref([
                {field: 'nameEn', header: '作品名称(英文)'},
                {field: 'remark', header: '备注'},
                {field: 'addedTime', header: '收录时间'},
                {field: 'editedTime', header: '编辑时间'},
            ]);
            const filters = ref({
                'name': {value: '', matchMode: 'contains'},
                'nameZh': {value: '', matchMode: 'contains'},
                'franchise': {value: null, matchMode: FilterMatchMode.IN},
                'category': {value: null, matchMode: FilterMatchMode.IN},
            });
            const onPage = (event) => {
                queryParams.value = event;
                getProducts();
            };
            const onSort = (event) => {
                queryParams.value = event;
                getProducts();
            };
            const onFilter = () => {
                queryParams.value.filters = filters.value;
                queryParams.value.first = 0;
                getProducts();
            };
            const getProducts = () => {
                axiosPostRequest(GET_PRODUCTS_URL, {queryParams: queryParams.value})
                    .then(res => {
                        products.value = res.data;
                        totalRecords.value = res.total;
                    })
            };
            //endregion

            //region ------新增、编辑------
            const product = ref({});
            const productEdit = ref({});

            const displayEditDialog = ref(false);
            const displayNewDialog = ref(false);

            //打开新增数据面板
            const openNewDialog = () => {
                product.value = {};
                displayNewDialog.value = true;
            };
            //关闭新增数据面板
            const closeNewDialog = () => {
                product.value = {};
                displayNewDialog.value = false;
            };
            //提交新增数据
            const submitNewProduct = () => {
                axiosPostRequest(ADD_PRODUCT_URL, product.value)
                    .then(res => {
                        if (res.state === 1) {
                            product.value = {};
                            toast.add({
                                severity: 'success',
                                summary: 'Successful',
                                detail: res.message,
                                life: 3000
                            });
                            closeNewDialog();
                            location.reload(true);
                        } else {
                            toast.add({severity: 'error', summary: 'Error', detail: res.message, life: 3000});
                        }
                    });
            };

            //打开编辑数据面板
            const openEditDialog = (data) => {
                let dataTmp = JSON.parse(JSON.stringify(data));
                productEdit.value = dataTmp;
                productEdit.value.franchise = dataTmp.franchise.value;
                productEdit.value.category = dataTmp.category.id;
                displayEditDialog.value = true;
            };
            //关闭编辑数据面板
            const closeEditDialog = () => {
                displayEditDialog.value = false;
                productEdit.value = {};
            };
            //保存编辑数据
            const submitEditProduct = async () => {
                await axiosPostRequest(UPDATE_PRODUCT_URL, productEdit.value)
                    .then(res => {
                        if (res.state === 1) {
                            productEdit.value = {};
                            toast.add({
                                severity: 'success',
                                summary: 'Successful',
                                detail: res.message,
                                life: 3000
                            });
                            closeEditDialog();
                            location.reload(true);
                        } else {
                            toast.add({severity: 'error', summary: 'Error', detail: res.message, life: 3000});
                        }
                    }).catch(e => {
                        console.error(e);
                    });
            };
            //endregion

            //region 页面header
            const dialog = useDialog();
            const openSearchPanel = () => {
                showSearchPanel(dialog);
            }
            //endregion

            //region ------基础配置------
            const loading = ref(false);
            const dt = ref();
            const selectedColumns = ref();
            const toast = useToast();
            const exportCSV = () => {
                axiosGetRequest(CHECK_USER_AUTHORITY_URL, null)
                    .then(res => {
                        if (res.state === 0) {
                            toast.add({severity: 'error', summary: 'Error', detail: res.message, life: 3000});
                        } else {
                            dt.value.exportCSV();
                        }
                    })
            };
            //endregion

            const init = () => {
                loading.value = true;
                queryParams.value = {
                    first: 0,
                    rows: dt.value.rows,
                    sortField: null,
                    sortOrder: null,
                    filters: filters.value
                };
                getProducts();
                loading.value = false;
            };

            return {
                dt, onToggle, onPage, onSort, onFilter, filters, totalRecords, loading,
                productEdit, displayEditDialog, openEditDialog, closeEditDialog, submitEditProduct,
                product, displayNewDialog, openNewDialog, closeNewDialog, submitNewProduct,
                filters, franchiseSet, productCategorySet,
                toast, dialog, openSearchPanel, NOT_LOGIN_NAVBAR_ITEMS, LOGIN_NAVBAR_ITEMS, exportCSV,
                products, selectedColumns, columns, onToggle
            }
        },
        components: {
            "p-dropdown": primevue.dropdown,
            "p-button": primevue.button,
            "p-menubar": primevue.menubar,
            "p-avatar": primevue.avatar,
            "p-inputtext": primevue.inputtext,
            "p-toast": primevue.toast,
            "p-datatable": primevue.datatable,
            "p-column": primevue.column,
            "p-multiselect": primevue.multiselect,
            "p-toolbar": primevue.toolbar,
            "p-calendar": primevue.calendar,
            "p-textarea": primevue.textarea,
            "p-panel": primevue.panel,
            "p-divider": primevue.divider,
            "p-dialog": primevue.dialog,

            "p-chip": primevue.chip,
            "p-tag": primevue.tag,
            "p-scrollpanel": primevue.scrollpanel,
            "p-scrolltop": primevue.scrolltop,
            "p-paginator": primevue.paginator,
            "p-dynamicdialog": primevue.dynamicdialog,
        }
    };

    const routes = [{path: "/", component: App}];

    const router = VueRouter.createRouter({
        // history: VueRouter.createWebHashHistory(),
        history: VueRouter.createWebHistory(),
        routes
    });

    createApp(App)
        .use(router)
        .use(primevue.toastservice)
        .use(primevue.config.default)
        .directive('tooltip', Tooltip)
        .use(primevue.dialogservice)
        .mount("#app");
</script>
<style>
    .product-image {
        /*width: 50px;*/
        height: 50px;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.16), 0 3px 6px rgba(0, 0, 0, 0.23)
    }
</style>
</body>
</html>