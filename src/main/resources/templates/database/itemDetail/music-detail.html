<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title th:text="${music.name}"></title>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width,initial-scale=1.0"/>

    <!-- bootstrap -->
    <link rel="stylesheet" th:href="@{/css/bootstrap/myBootstrap.min.css}">
    <script th:src="@{/tool/bootstrap/bootstrap.min.js}"></script>

    <!--other css -->
    <link href="https://img.rakbow.com/common/logo/favicon.ico" type="image/x-icon" rel="shortcut icon"/>
    <link th:href="@{/css/global.css}" rel="stylesheet"/>
    <link th:href="@{/css/topbar.css}" rel="stylesheet"/>
    <link th:href="@{/css/topbar.css}" rel="stylesheet"/>
    <link th:href="@{/css/search.css}" rel="stylesheet"/>
    <link th:href="@{/css/iconfont/iconfont.css}" rel="stylesheet"/>

    <!-- PrimeVue -->
    <link th:href="@{/css/primevue/bootstrap4-dark-blue.css}" rel="stylesheet"/>
    <link th:href="@{/css/primevue/primevue.min.css}" rel="stylesheet"/>
    <link th:href="@{/css/primevue/primeflex.min.css}" rel="stylesheet"/>
    <link th:href="@{/css/primevue/primeicon/primeicons.css}" rel="stylesheet"/>

    <!-- Vue3 -->
    <script th:src="@{/js/vue/vue.global.min.js}"></script>
    <script th:src="@{/js/primevue/core.min.js}"></script>
    <script th:src="@{/js/vue/vue-router.global.min.js}"></script>

    <!-- PrimeVue Components -->
    <script th:src="@{/js/primevue/components/panel.min.js}"></script>
    <script th:src="@{/js/primevue/components/divider.min.js}"></script>
    <script th:src="@{/js/primevue/components/dialog.min.js}"></script>
    <script th:src="@{/js/primevue/components/fieldset.min.js}"></script>
    <script th:src="@{/js/primevue/components/fieldset.min.js}"></script>
    <script th:src="@{/js/primevue/components/chips.min.js}"></script>
    <script th:src="@{/js/primevue/components/inputtext.min.js}"></script>
    <script th:src="@{/js/primevue/components/menubar.min.js}"></script>
    <script th:src="@{/js/primevue/components/avatar.min.js}"></script>
    <script th:src="@{/js/primevue/components/toast.min.js}"></script>
    <script th:src="@{/js/primevue/components/toastservice.min.js}"></script>
    <script th:src="@{/js/primevue/components/textarea.min.js}"></script>
    <script th:src="@{/js/primevue/components/inputnumber.min.js}"></script>
    <script th:src="@{/js/primevue/components/inputswitch.min.js}"></script>
    <script th:src="@{/js/primevue/components/splitbutton.min.js}"></script>
    <script th:src="@{/js/primevue/components/datatable.min.js}"></script>
    <script th:src="@{/js/primevue/components/column.min.js}"></script>
    <script th:src="@{/js/primevue/components/contextmenu.min.js}"></script>
    <script th:src="@{/js/primevue/components/card.min.js}"></script>
    <script th:src="@{/js/primevue/components/inplace.min.js}"></script>

    <script th:src="@{/js/primevue/components/fileupload.min.js}"></script>
    <script th:src="@{/js/primevue/components/blockui.min.js}"></script>
    <script th:src="@{/js/primevue/components/progressbar.min.js}"></script>

    <script th:src="@{/js/primevue/components/scrolltop.min.js}"></script>
    <script th:src="@{/js/primevue/components/scrollpanel.min.js}"></script>
    <script th:src="@{/js/primevue/components/dynamicdialog.min.js}"></script>
    <script th:src="@{/js/primevue/components/dialogservice.min.js}"></script>
    <script th:src="@{/js/primevue/components/divider.min.js}"></script>
    <script th:src="@{/js/primevue/components/chip.min.js}"></script>
    <script th:src="@{/js/primevue/components/menubar.min.js}"></script>
    <script th:src="@{/js/primevue/components/avatar.min.js}"></script>
    <script th:src="@{/js/primevue/components/tag.min.js}"></script>

    <!-- Jquery -->
    <script th:src="@{/js/jquery.js}"></script>

    <!-- high light js -->
    <link th:href="@{/tool/highlight/default.min.css}" rel="stylesheet">
    <script th:src="@{/tool/highlight/highlight.min.js}"></script>

    <!-- md-editor-v3 -->
    <script th:src="@{/tool/md-editor-v3/md-editor-v3.umd.js}"></script>
    <link th:href="@{/tool/md-editor-v3/style.min.css}" rel="stylesheet">

    <!-- marked -->

    <link th:href="@{/css/github-markdown/github-markdown.css}" rel="stylesheet"/>

    <!-- aPlayer -->
    <link th:href="@{/tool/aplayer/APlayer.min.css}" rel="stylesheet">
    <script th:src="@{/tool/aplayer/APlayer.min.js}"></script>

    <!-- flag-icons -->
    <link th:href="@{/css/flag-icons/css/flag-icons.css}" rel="stylesheet">

    <!-- basic js -->
    <script th:src="@{/js/basic/Data_Helper.js}"></script>
    <script th:src="@{/js/basic/Rakbow_Web_Url_Helper_Str.js}"></script>
    <script th:src="@{/js/basic/Rakbow_Web_Exception_Str_CN.js}"></script>

    <link th:href="@{/css/item-detail.css}" rel="stylesheet"/>

    <!-- tingle -->
    <script th:src="@{/tool/tingle/tingle.min.js}"></script>
    <link th:href="@{/tool/tingle/tingle.min.css}" rel="stylesheet">
</head>
<body>
 <div id="app" style="margin-top: 60px">
    <!-- 头部 -->
    <header class="sticky-top mb-2" th:insert="~{template/header :: site_header}"></header>

    <div id="main" class="grid mt-2">
        <p-toast></p-toast>
        <div class="detail-card col-8 lg:col-offset-1 md:col-offset-1">
            <p-card>
                <template #title>
                    <div class="grid detail-item-header-title">
                        <h4 class="col-11">
                            <b class="detail-item-title">
                                <i class="pi iconfont icon-music" style="font-size: 1.5rem"></i>
                                {{music.name}}
                            </b>
                        </h4>
                        <div th:insert="~{template/item-detail-template :: item_common_edit_button}"></div>
                    </div>
                </template>
                <template #subtitle>
                    <h5 v-if="music.nameEn != ''" class="detail-item-subtitle"><small
                            class="ml-4">{{music.nameEn}}</small></h5>
                    <h5 v-else><small></small></h5>
                </template>
                <template #content>
                    <div class="grid">
                        <div class="col-4" style="width: 90px">
                            <div class="music-detail-cover">
                                <img :src="music.cover" alt="cover"/>
                            </div>
                        </div>
                        <div class="col detail-item-header-card">
                            <p-card>
                                <template #content>
                                    <div class="relative">
                                        <table class="table-borderless table-sm ml-2">
                                            <tbody class="detail-item-header-table">
                                            <tr>
                                                <td><strong>音频长度</strong></td>
                                                <td>
                                                    {{music.audioLength}}
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><strong>音频类型</strong></td>
                                                <td>
                                                    {{music.audioType.label}}
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><strong>碟片序号</strong></td>
                                                <td>
                                                    {{music.discSerial}}
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><strong>曲目序号</strong></td>
                                                <td>
                                                    {{music.trackSerial}}
                                                </td>
                                            </tr>
                                            </tbody>
                                        </table>
                                        <div th:insert="~{template/item-detail-template :: item_status_edit}" th:if="${loginUser != null}"></div>
                                        <div th:insert="~{template/item-detail-template :: item_statistic_info}"></div>
                                    </div>
                                </template>
                            </p-card>
                        </div>
                    </div>
                    <div class="detail-item-field">
                        <!-- audio player -->
                        <p-fieldset :toggleable="true">
                            <template #legend>
                                <i class="pi iconfont icon-music"></i>
                                <b>在线播放</b>
                            </template>
                            <p-button v-if="audioInfo!=null" @click="playerOption.fixed=true, createAplayer()" class="mr-2"
                                      v-tooltip.bottom="'切换播放器至底部'">
                                <i class="pi pi-arrow-circle-down"></i>
                            </p-button>
                            <div id="aplayer"></div>
                        </p-fieldset>
                        <!-- artists -->
                        <p-fieldset :toggleable="true">
                            <template #legend>
                                <i class="pi pi-users"></i>
                                <b>音乐创作</b>
                            </template>
                            <div class="grid ml-4" v-if="music.artists.length != 0">
                                <table class="table-borderless table-sm">
                                    <tbody class="detail-item-artists-table">
                                    <tr v-for="artist in music.artists">
                                        <td width="120px"><strong>{{artist.pos}}</strong></td>
                                        <td>
                                            {{artist.name.join(", ")}}
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div v-else>
                                <span class="emptyInfo"><em>暂无音乐创作相关信息</em></span>
                            </div>
                        </p-fieldset>
                        <!-- lyrics -->
                        <p-fieldset :toggleable="true">
                            <template #legend>
                                <i class="pi iconfont icon-music"></i>
                                <b>歌词</b>
                            </template>
                            <article id="lyrics" class="markdown-body" style="width: 100%;"></article>
                        </p-fieldset>
                        <!-- description -->
                        <div th:insert="~{template/item-detail-template :: description_field_set}"></div>
                    </div>
                </template>
            </p-card>
        </div>
        <div class="col-2" style="min-width: 300px">
            <p-panel>
                <template #header>
                    <span class="text-start side-panel-header">
                        <i class="pi pi-th-large"></i><span><strong>相关信息</strong></span>
                    </span>
                </template>
                <p-divider align="center">
                    <i class="pi iconfont icon-24gl-musicAlbum2 mr-1" style="font-size: 1.5rem"></i>
                    <span><b>所属专辑</b></span>
                </p-divider>
                <div class="grid">
                    <span class="small_font">
                        <div class="info_bit_small small_font grid related-album">
                            <div class="sidebar-panel-image-small-div album_info_bit_thumb mt-2">
                                <a :href="'/db/album/'+ relatedAlbum.id">
                                    <img class="sidebar-panel-image-small" :src="relatedAlbum.cover.blackUrl">
                                </a>
                            </div>
                            <div class="col p-0" style="height: 80px">
                                <ul class="info_bit_small_other">
                                    <li>
                                        <a class="small_font" :href="'/db/album/'+ relatedAlbum.id ">
                                            <span class="text-truncate-2 mr-2">
                                                {{relatedAlbum.name}}
                                            </span>
                                        </a>
                                    </li>
                                    <li>
                                        <span class="small_font col-6 related-item-catalog">
                                            {{relatedAlbum.catalogNo ? relatedAlbum.catalogNo : 'N/A'}}
                                        </span>
                                        <span class="small_font col-6 related-item-date">
                                            {{relatedAlbum.releaseDate}}
                                        </span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </span>
                </div>
                <span class="ml-3">所属该专辑的第<b>{{music.discSerial}}</b>
                                        张碟片，第<b>{{music.trackSerial}}</b>首曲目</span>
                <p-divider align="center">
                    <i class="pi iconfont icon-music mr-1" style="font-size: 1.5rem"></i>
                    <span><b>相关曲目</b></span>
                </p-divider>
                <table class="table table-sm table-hover">
                    <tbody class="detail-item-track-table">
                    <tr v-for="music in relatedMusics">
                        <th>{{music.trackSerial}}</th>
                        <td class="text-truncate-1" style="width: 200px">
                            <a :href="'/db/music/' + music.id">
                                {{music.name}}
                            </a>
                        </td>
                        <td class="text-end" style="color: #b0c4de">
                            <span v-if="music.audioLength == '00:00'">
                                N/A
                            </span>
                            <span v-else>
                                {{music.audioLength}}
                            </span>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </p-panel>
            <br>
            <div th:insert="~{template/item-detail-template :: page_info_card}"></div>
        </div>
    </div>
    <p-dialog :modal="true" v-model:visible="displayEditDialog" :style="{width: '500px'}" header="编辑基础信息"
              class="p-fluid">
        <p-blockui :blocked="editBlock">
            <div class="formgrid grid">
                <div class="field col">
                    <label>曲名<span style="color: red">*</span></label>
                    <p-inputtext v-model.trim="musicEdit.name"></p-inputtext>
                </div>
                <div class="field col">
                    <label>曲名(英语)</label>
                    <p-inputtext v-model.trim="musicEdit.nameEn"></p-inputtext>
                </div>
            </div>
            <div class="formgrid grid">
                <div class="field col">
                    <label>音频类型<span style="color: red">*</span></label>
                    <p-dropdown v-model="musicEdit.audioType" :options="audioTypeSet"
                                option-label="label" option-value="value">
                    </p-dropdown>
                </div>
                <div class="field col">
                    <label>音频长度<span style="color: red">*</span></label>
                    <p-inputtext v-model.trim="musicEdit.audioLength"
                                 placeholder="00:00"></p-inputtext>
                </div>
            </div>
            <div class="formgrid grid">
                <div class="field col">
                    <label>碟片序号<span style="color: red">*</span></label>
                    <p-inputnumber v-model="musicEdit.discSerial"
                                   :disabled="true"></p-inputnumber>
                </div>
                <div class="field col">
                    <label>曲目序号<span style="color: red">*</span></label>
                    <p-inputtext v-model="musicEdit.trackSerial" :disabled="true"></p-inputtext>
                </div>
            </div>
            <div class="field">
                <label>备注</label>
                <p-textarea v-model.trim="musicEdit.remark" rows="3" cols="20" :auto-resize="true"></p-textarea>
            </div>
        </p-blockui>
        <template #footer>
            <p-button label="取消" icon="pi pi-times" class="p-button-text"
                      @click="closeEditDialog" :disabled="editBlock"></p-button>
            <p-button label="保存" icon="pi pi-check" class="p-button-text"
                      @click="submitEditMusic" :disabled="editBlock"></p-button>
        </template>
    </p-dialog>
    <p-dialog :modal="true" v-model:visible="displayFileEditDialog" header="文件管理"
              :style="{width: '800px'}">
        <p-blockui :blocked="editBlock">
            <p-panel>
                <div class="grid">
                    <div class="col-6 text-start">
                        <p-fileupload
                                :disabled="music.uploadDisabled"
                                mode="basic"
                                :custom-upload="true"
                                :auto="true"
                                choose-label="上传文件"
                                :max-file-size="20000000" :preview-width="100"
                                invalid-file-size-message="{0}大小已超过{1}"
                                @uploader="onUpload"
                                @select="selectFile">
                        </p-fileupload>
                    </div>
                    <div class="col-6 text-end" v-if="!music.uploadDisabled">
                        <p-button class="ml-2 p-button-text" icon="pi pi-trash"
                                  label="清空所选" @click="clearUploadedFile"></p-button>
                    </div>
                    <p-divider></p-divider>
                    <div class="col-12" v-if="music.uploadDisabled">
                        <div align="center">
                            <span class="emptyInfo">音频文件和歌词文件已上传。如需更新，请先删除文件。</span>
                        </div>
                    </div>
                    <div class="col-12" v-else>
                        <div v-if=" fileHtml == '' " align="center">
                            <span class="emptyInfo">还未选择文件</span>
                        </div>
                        <div>
                            <section>
                                <div id="fileBox" v-html="fileHtml"></div>
                            </section>
                        </div>
                    </div>
                </div>
            </p-panel>
            <p-panel>
                <template #header>
                    <i class="pi pi-pencil mr-2" style="font-size: 2rem"></i>
                    <b>编辑</b>
                </template>
                <div v-if="music.files.length != 0">
                    <p-datatable :value="music.files" class="p-datatable-sm" striped-rows
                                 :resizable-columns="true" column-resize-mode="expand"
                                 v-model:selection="selectedFiles">
                        <template #header>
                            <p-button icon="pi pi-trash" class="p-button-danger"
                                      @click="confirmDeleteSelectedFile"></p-button>
                        </template>
                        <p-column selection-mode="multiple" header-style="width: 4%"></p-column>
<!--                        <p-column field="url" header="URL" header-style="width: 10%">-->
<!--                            <template #body="slotProps">-->
<!--                                {{slotProps.data.url.substr(22)}}-->
<!--                            </template>-->
<!--                        </p-column>-->
                        <p-column field="name" header="文件名" header-style="width: 10%"></p-column>
                        <p-column field="type" header="文件类型" header-style="width: 8%">
                            <template #body="slotProps">
                                {{slotProps.data.type}}
                            </template>
                        </p-column>
                        <p-column field="size" header="文件大小" header-style="width: 15%">
                            <template #body="slotProps">
                                {{(slotProps.data.size/1024).toFixed(2)}}KB
                            </template>
                        </p-column>
                        <p-column field="uploadTime" header="上传时间" header-style="width: 10%"></p-column>
                        <p-column field="uploadUser" header="上传用户" header-style="width: 10%"></p-column>
                    </p-datatable>
                </div>
                <div v-else>
                    <span class="emptyInfo"><em>暂无文件</em></span>
                </div>
            </p-panel>
        </p-blockui>
        <template #footer>
            <p-button icon="pi pi-times" label="取消" @click="closeFileEditDialog"
                      class="p-button-text" :disabled="editBlock"></p-button>
            <p-button icon="pi pi-save" label="提交更新" @click="uploadFile" :disabled="editBlock"></p-button>
        </template>
    </p-dialog>
    <p-dialog :modal="true" v-model:visible="deleteFileDialog" header="删除文件"
              :breakpoints="{'960px': '50vw', '640px': '70vw'}" :style="{width: '50vw'}">
        <div class="confirmation-content">
            <i class="pi pi-exclamation-triangle mr-3" style="font-size: 2rem"></i>
            <span v-if="album">确定删除所选的文件？</span>
        </div>
        <template #footer>
            <p-button label="取消" icon="pi pi-times" class="p-button-text"
                      @click="cancelDeleteSelectedFile" :disabled="editBlock"></p-button>
            <p-button label="确认删除" icon="pi pi-check" class="p-button-text"
                      @click="deleteFile" :disabled="editBlock"></p-button>
        </template>
    </p-dialog>
    <p-dialog :modal="true" v-model:visible="displayArtistEditDialog" :style="{width: '800px'}" header="编辑创作">
        <p-blockui :blocked="editBlock">
            <p-panel>
                <template #header>
                    <i class="pi pi-user-plus mr-2" style="font-size: 2rem"></i>
                    <b>新增</b>
                </template>
                <div class="grid">
                    <div class="col-3">
                        <div class="p-inputgroup">
                                        <span class="p-inputgroup-addon">
                                            <i class="pi pi-tag"></i>
                                        </span>
                            <p-inputtext v-model="artist.pos" placeholder="职位名称"></p-inputtext>
                        </div>
                    </div>
                    <div class="col-7">
                        <div class="p-inputgroup">
                                        <span class="p-inputgroup-addon">
                                            <i class="pi pi-users"></i>
                                        </span>
                            <p-chips v-model="artist.name" placeholder="人员信息" separator=","></p-chips>
                        </div>
                    </div>
                    <div class="col-2">
                        <p-button label="新增" icon="pi pi-save"
                                  @click="addArtist"></p-button>
                    </div>
                </div>
            </p-panel>
            <p-panel>
                <template #header>
                    <i class="pi pi-user-edit mr-2" style="font-size: 2rem"></i>
                    <b>编辑</b>
                </template>
                <div v-if="music.artists.length != 0">
                    <p-datatable dataKey="id" :value="music.artists" responsive-layout="scroll"
                                 class="p-datatable-sm" striped-rows @row-reorder="onRowReorder"
                                 context-menu v-model:context-menu-selection="selectedArtist"
                                 @row-contextmenu="artistRowMenu" edit-mode="row"
                                 v-model:editing-rows="editingRows" @row-edit-save="onRowEditSave">
                        <p-column :row-reorder="true"></p-column>
                        <p-column field="pos" header="职位">
                            <template #editor="{ data, field }">
                                <p-inputtext v-model="data[field]" autofocus></p-inputtext>
                            </template>
                        </p-column>
                        <p-column field="name" header="人员">
                            <template #body="slotProps">
                                {{slotProps.data.name.join(" / ")}}
                            </template>
                            <template #editor="{ data, field }">
                                <p-chips v-model="data[field]"></p-chips>
                            </template>
                        </p-column>
                        <p-column :row-editor="true" style="width:10%; min-width:8rem"
                                  bodyStyle="text-align:center"></p-column>
                    </p-datatable>
                    <p-contextmenu :model="menuModel" ref="cm"></p-contextmenu>
                </div>
                <div v-else>
                    <span class="emptyInfo">暂无创作人员相关信息</span>
                </div>
            </p-panel>
        </p-blockui>
        <template #footer>
            <p-button label="清空" icon="pi pi-trash" class="p-button-danger mr-4"
                      @click="clearArtists" :disabled="editBlock"></p-button>
            <p-button label="取消" icon="pi pi-times" class="mr-4"
                      @click="cancelArtistEdit" :disabled="editBlock"></p-button>
            <p-button label="更新" icon="pi pi-save" class="p-button-success mr-4"
                      @click="submitArtist" :disabled="editBlock"></p-button>
        </template>
    </p-dialog>
    <p-dialog :modal="true" v-model:visible="displayLyricsDialog" header="编辑歌词文本"
              :breakpoints="{'960px': '75vw', '640px': '90vw'}" :style="{width: '80vw'}">
        <p-blockui :blocked="editBlock">
            <md-editor-v3 v-model="lyricsMd" preview-theme="github"></md-editor-v3>
        </p-blockui>
        <template #footer>
            <p-button label="取消" icon="pi pi-times" @click="closeLyricsEditDialog"
                      class="p-button-text" :disabled="editBlock"></p-button>
            <p-button label="保存" icon="pi pi-save" @click="submitLyrics"
                      autofocus  :disabled="editBlock"></p-button>
        </template>
    </p-dialog>
    <p-dynamicdialog></p-dynamicdialog>
    <!-- 尾部 -->
    <footer class="mt-2" th:insert="~{template/footer :: site_footer}"></footer>
</div>
<script type="module" th:inline="javascript">
    import {marked} from '/tool/marked/marked.esm.js';
    import {postRequest, commonSubmit, formRequest} from '/js/basic/Http_Request.js';
    import {showSearchPanel} from '/js/basic/Rakbow_Web_Search_Params.js';
    import {showDescriptionEditDialog} from '/js/basic/Item_Detail_Text_Params.js';
    const {createApp, onMounted, ref} = Vue;
    const Tooltip = primevue.tooltip;
    const { useDialog } = primevue.usedialog;
    const {useToast} = primevue.usetoast;

    const App = {
        setup() {
            onMounted(() => {
                init();
                $(window).resize(function () {
                    $("#main").attr("style", "min-height:" + ($(window).height() - 350) + 'px');
                });
            })

            //region tingle
            const descriptionModal = new tingle.modal({
                closeMethods: ['overlay', 'button', 'escape'],
                closeLabel: "Close",
                cssClass: ['tingle-markdown-body'],
                onOpen: function () {
                    if (detailInfo.value.description != null && detailInfo.value.description !== "") {
                        descriptionModal.setContent(marked.parse(detailInfo.value.description));
                    }
                }
            });

            const openTingleDescription = () => {
                descriptionModal.open();
            };
            //endregion

            //region common header
            const dialog = useDialog();
            const openSearchPanel = () => {
                showSearchPanel(dialog);
            }
            //endregion

            //region audio player

            const playerOption = ref({
                fixed: false,
            });
            const createAplayer = () => {

                if (audioInfo.value !== null) {
                    const ap = new APlayer({
                        container: document.getElementById('aplayer'),
                        volume: 0.5,
                        lrcType: 3,
                        fixed: playerOption.value.fixed,
                        audio: [audioInfo.value]
                    });
                }else {
                    //<![CDATA[
                    document.getElementById('aplayer').innerHTML = "<span class='emptyInfo'>暂无音频文件</span>";
                    //]]>
                }
            };
            //endregion

            //region basic
            const music = ref([[${music}]]);
            const toast = useToast();
            const pageInfo = ref([[${pageInfo}]]);
            const detailInfo = ref([[${detailInfo}]]);
            const audioInfo = ref([[${audioInfo}]]);
            const relatedAlbum = ref([[${relatedAlbum}]]);
            const audioTypeSet = ref([[${options.audioTypeSet}]]);
            const relatedMusics = ref([[${relatedMusics}]]);
            //endregion

            //region files
            const deleteFileDialog = ref(false);
            const selectedFiles = ref([]);
            const confirmDeleteSelectedFile = () => {
                deleteFileDialog.value = true;
            };
            const cancelDeleteSelectedFile = () => {
                selectedFiles.value = [];
                deleteFileDialog.value = false;
            };
            const fileHtml = ref("");
            const fileInfo = ref({
                file: null,
                name: '',
                size: 0,
                type: ''
            });
            const fileInfos = ref([]);
            const displayFileEditDialog = ref(false);
            const openFileEditDialog = () => {
                fileInfo.value = {};
                displayFileEditDialog.value = true;
            };
            const showFile = () => {
                fileHtml.value = "";
                //<![CDATA[
                fileHtml.value += "<div class='grid'>";
                for (const file of fileInfos.value) {
                    fileHtml.value += '<div class="col-12">';
                    fileHtml.value += '<p>文件名: ' + file.name + '</p>';
                    fileHtml.value += '<p>文件大小: ' + (file.size / 1024).toFixed(2) + 'KB</p>';
                    fileHtml.value += '<p>文件类型: ' + file.type + '</p>';
                    fileHtml.value += '</div>';
                }
                fileHtml.value += "</div>";
                //]]>
                document.getElementById("fileBox").innerHTML = fileHtml;
            };
            const closeFileEditDialog = () => {
                fileInfo.value = {};
                displayFileEditDialog.value = false;
            };
            const onUpload = (ev) => {
                toast.add({severity: 'info', summary: 'Success', detail: FILE_SELECTED_INFO, life: 3000});
            };
            const clearUploadedFile = () => {
                fileInfos.value = [];
                document.getElementById("fileBox").innerHTML = "";
            };
            const selectFile = (ev) => {
                fileInfo.value.file = ev.files[0];
                if (ev.files[0].type === 'audio/mpeg') {
                    fileInfo.value.type = ev.files[0].type;
                    fileInfo.value.name = ev.files[0].name;
                    fileInfo.value.size = ev.files[0].size;
                }
                if (ev.files[0].name.substr(ev.files[0].name.lastIndexOf('.') + 1) === 'lrc') {
                    fileInfo.value.type = 'text/lrc';
                    fileInfo.value.name = ev.files[0].name;
                    fileInfo.value.size = ev.files[0].size;
                }
                fileInfos.value.push(fileInfo.value);
                fileInfo.value = {};
                showFile();
            };
            const uploadFile = () => {
                editBlock.value = true;
                const formData = new FormData();
                for (const file of fileInfos.value) {
                    formData.append("files", file.file);
                }
                formData.append("id", music.value.id);
                formData.append("fileInfos", JSON.stringify(fileInfos.value));
                formRequest(toast, editBlock, UPLOAD_MUSIC_FILE_URL, formData)
                    .then(res => {
                        if (res.state === 1) {
                            editBlock.value = false;
                            closeFileEditDialog();
                            location.reload(true);
                        }
                    }).catch(err => {
                    console.error(err);
                });
            };
            const deleteFile = () => {
                let json = {
                    id: music.value.id,
                    files: selectedFiles.value
                };
                postRequest(null, DELETE_MUSIC_FILE_URL, json)
                    .then(res => {
                        if (res.state === 1) {
                            deleteFileDialog.value = false;
                            closeFileEditDialog();
                            selectedFiles.value = [];
                            location.reload(true);
                        }
                    }).catch(err => {
                    console.error(err);
                });
            };
            //endregion

            //region edit
            const like = () => {
                let json = {
                    entityType: ENTITY.MUSIC,
                    entityId: detailInfo.value.id
                }
                postRequest(toast, LIKE_ITEM_URL, json)
                    .then(res => {
                        if (res.state === 1) {
                            pageInfo.value.likeCount++;
                            pageInfo.value.liked = true;
                        }
                    });
            };
            const updateStatus = () => {
                editBlock.value = true;
                let json = {
                    entityType: ENTITY.MUSIC,
                    entityId: detailInfo.value.id,
                    status: !detailInfo.value.status
                };
                commonSubmit(toast, editBlock, UPDATE_ITEM_STATUS, json);
            };
            const musicEdit = ref({});
            const editBlock = ref(false);
            const edits = ref([
                {
                    label: '创作人员',
                    icon: 'pi pi-users',
                    command: () => {
                        openArtistEditDialog();
                    }
                },
                {
                    label: '描述信息',
                    icon: 'pi iconfont icon-miaoshu',
                    command: () => {
                        showDescriptionEditDialog(toast, dialog, detailInfo.value, itemImageInfo.value.images);
                    }
                },
                {
                    label: '编辑歌词',
                    icon: 'pi iconfont icon-music',
                    command: () => {
                        openLyricsEditDialog();
                    }
                },
                {
                    label: '文件管理',
                    icon: 'pi pi-file',
                    command: () => {
                        openFileEditDialog();
                    }
                },
            ]);
            const displayEditDialog = ref(false);
            //打开编辑数据面板
            const openEditDialog = () => {
                let dataTmp = JSON.parse(JSON.stringify(music.value));
                musicEdit.value = dataTmp;
                musicEdit.value.audioType = dataTmp.audioType.value;
                displayEditDialog.value = true;
            };
            //关闭编辑基础信息面板
            const closeEditDialog = () => {
                displayEditDialog.value = false;
                musicEdit.value = {};
            };
            //保存编辑好的基础信息
            const submitEditMusic = () => {
                editBlock.value = true;
                commonSubmit(toast, editBlock, UPDATE_MUSIC_URL, musicEdit.value)
                    .then(res => {
                        if (res.state === 1) {
                            musicEdit.value = {};
                            closeEditDialog();
                            location.reload(true);
                        }
                    })
                    .catch(error => {
                        console.error(error);
                    });
            };
            //endregion

            //region artists
            const cm = ref();
            const selectedArtist = ref();
            const artist = ref({});
            const artists = ref([]);
            const displayArtistEditDialog = ref(false);
            const menuModel = ref([
                {label: '删除', icon: 'pi pi-fw pi-user-minus', command: () => deleteArtist(selectedArtist)}
            ]);
            const artistRowMenu = (ev) => {
                cm.value.show(ev.originalEvent);
            };
            const deleteArtist = (artist) => {
                music.value.artists = music.value.artists.filter((a) => a.pos !== artist.value.pos);
                toast.add({severity: 'error', summary: '已删除', detail: artist.pos, life: 3000});
                selectedArtist.value = null;
            };
            const editingRows = ref([]);
            const onRowEditSave = (ev) => {
                let {newData, index} = ev;

                music.value.artists[index] = newData;
            };

            const openArtistEditDialog = () => {
                artist.value = {};
                displayArtistEditDialog.value = true;
            };
            const clearArtists = () => {
                music.value.artists = [];
            };
            const addArtist = () => {
                music.value.artists.push(artist.value);
                artist.value = {};
            }
            const cancelArtistEdit = () => {
                artist.value = {};
                displayArtistEditDialog.value = false;
            };
            const submitArtist = () => {
                editBlock.value = true;
                let json = {
                    id: music.value.id,
                    artists: music.value.artists
                }
                commonSubmit(toast, editBlock, UPDATE_MUSIC_ARTISTS_URL, json)
                    .then(res => {
                        if (res.state === 1) {
                            displayArtistEditDialog.value = false;
                            artist.value = {};
                            location.reload(true);
                        }
                    })
            };
            const onRowReorder = (ev) => {
                music.value.artists = ev.value;
                toast.add({severity: 'success', summary: 'Rows Reordered', life: 3000});
            };
            //endregion

            //region lyrics
            const lyricsMd = ref("");
            const displayLyricsDialog = ref(false);
            const openLyricsEditDialog = () => {
                lyricsMd.value = music.value.lrcText;
                displayLyricsDialog.value = true;
            }
            const closeLyricsEditDialog = () => {
                displayLyricsDialog.value = false;
                lyricsMd.value = "";
            }
            const submitLyrics = () => {
                editBlock.value = true;
                let json = {
                    id: music.value.id,
                    lyricsText: lyricsMd.value
                }
                commonSubmit(toast, editBlock, UPDATE_MUSIC_LYRICS_TEXT_URL, json)
                    .then(res => {
                        if (res.state === 1) {
                            music.value.lrcText = lyricsMd.value;
                            text2marked();
                            closeLyricsEditDialog();
                        }
                    });
            };
            //endregion

            //region init
            const init = () => {
                text2marked();
                $("#main").attr("style", "min-height:" + ($(window).height() - 350) + 'px');
                createAplayer();
            };
            const text2marked = () => {

                if (detailInfo.value.description != null && detailInfo.value.description !== "") {
                    document.getElementById("description").innerHTML = marked.parse(detailInfo.value.description);
                }

                if (music.value.lrcText != null && music.value.lrcText !== "") {
                    document.getElementById("lyrics").innerHTML = marked.parse(music.value.lrcText);
                } else {
                    //<![CDATA[
                    document.getElementById("lyrics").innerHTML = "<span class='emptyInfo'><em>暂无歌词</em></span>";
                    //]]>
                }
            };
            //endregion

            return {
                openTingleDescription,

                //header
                dialog, openSearchPanel, NOT_LOGIN_NAVBAR_ITEMS, LOGIN_NAVBAR_ITEMS,

                //basic
                music, updateStatus, like, pageInfo, detailInfo, audioTypeSet, relatedAlbum, relatedMusics,

                //edit
                editBlock, musicEdit, edits, displayEditDialog, openEditDialog, closeEditDialog, submitEditMusic,

                //audio player
                createAplayer, playerOption, audioInfo,

                //artists
                displayArtistEditDialog, cm, artist, artists, menuModel, editingRows, selectedArtist, addArtist,
                clearArtists, submitArtist, deleteArtist, cancelArtistEdit, artistRowMenu, onRowEditSave, onRowReorder,

                //lyrics
                lyricsMd, displayLyricsDialog, closeLyricsEditDialog, submitLyrics,

                //files
                displayFileEditDialog, openFileEditDialog, closeFileEditDialog, onUpload, clearUploadedFile, selectFile,
                uploadFile, fileHtml, deleteFileDialog, selectedFiles, confirmDeleteSelectedFile,
                cancelDeleteSelectedFile, deleteFile
            }
        },
        components: {
            "p-panel": primevue.panel,
            "p-fieldset": primevue.fieldset,
            "p-button": primevue.button,
            "p-dialog": primevue.dialog,
            "p-chips": primevue.chips,
            "p-divider": primevue.divider,
            "p-inputtext": primevue.inputtext,
            "p-menubar": primevue.menubar,
            "p-avatar": primevue.avatar,
            "p-toast": primevue.toast,
            "p-dropdown": primevue.dropdown,
            "p-textarea": primevue.textarea,
            "p-inputnumber": primevue.inputnumber,
            "p-inputswitch": primevue.inputswitch,
            "p-splitbutton": primevue.splitbutton,
            "p-datatable": primevue.datatable,
            "p-column": primevue.column,
            "p-contextmenu": primevue.contextmenu,
            "p-card": primevue.card,
            "p-blockui": primevue.blockui,
            "p-progressbar": primevue.progressbar,
            "p-inplace": primevue.inplace,
            "p-fileupload": primevue.fileupload,

            "p-tag": primevue.tag,
            "p-dynamicdialog": primevue.dynamicdialog,
        }
    };

    const routes = [{path: MUSIC_DETAIL_URL + [[${detailInfo.id}]], component: App}];

    const router = VueRouter.createRouter({
        history: VueRouter.createWebHistory(),
        routes
    });

    createApp(App)
        .use(router)
        .use(primevue.toastservice)
        .use(primevue.config.default)
        .use(MdEditorV3)
        .directive('tooltip', Tooltip)
        .use(primevue.dialogservice)
        .mount("#app");
</script>
<style>
    .aplayer .aplayer-info .aplayer-music .aplayer-title {
        color: black;
    }

    a:hover {
        /*border-bottom: 1px solid #ceffff;*/
        text-decoration: underline;
    }

    .related-album {
        margin: 0 0 0 1.25rem;
        padding: 0;
    }

    .music-detail-cover {
        transform: translateY(5px);
        width: 80px;
        height: 80px;
    }

    .p-tooltip-text {
        font-size: 11px;
        width: 13.5rem;
    }

    .title-container > span {
        font-size: .9rem;
        padding-left: .829rem;
    }

    .title-container > span.title {
        font-weight: bold;
    }
</style>
</body>
</html>