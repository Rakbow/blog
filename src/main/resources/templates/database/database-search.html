<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Database</title>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width,initial-scale=1.0"/>

    <!-- bootstrap -->
    <script th:src="@{/tool/bootstrap/bootstrap.min.js}"></script>

    <link th:href="@{/css/bootstrap/myBootstrap.min.css}" rel="stylesheet"/>

    <link href="https://img.rakbow.com/common/logo/favicon.ico" type="image/x-icon" rel="shortcut icon"/>
    <link th:href="@{/css/iconfont/iconfont.css}" rel="stylesheet"/>
    <link th:href="@{/css/remixicon/remixicon.css}" rel="stylesheet"/>

    <!-- PrimeVue css -->
    <link th:href="@{/css/primevue/bootstrap4-dark-blue.css}" rel="stylesheet"/>
    <link th:href="@{/css/primevue/primevue.min.css}" rel="stylesheet"/>
    <link th:href="@{/css/primevue/primeflex.min.css}" rel="stylesheet"/>
    <link th:href="@{/css/primevue/primeicon/primeicons.css}" rel="stylesheet"/>

    <!-- Vue3 -->
    <script th:src="@{/js/vue/vue.global.js}"></script>
    <script th:src="@{/js/primevue/core.min.js}"></script>
    <script th:src="@{/js/vue/vue-router.global.js}"></script>

    <!-- PrimeVue Components -->
    <script th:src="@{/js/primevue/components/inputtext.min.js}"></script>
    <script th:src="@{/js/primevue/components/divider.min.js}"></script>
    <script th:src="@{/js/primevue/components/chip.min.js}"></script>
    <script th:src="@{/js/primevue/components/menubar.min.js}"></script>
    <script th:src="@{/js/primevue/components/avatar.min.js}"></script>
    <script th:src="@{/js/primevue/components/tag.min.js}"></script>
    <script th:src="@{/js/primevue/components/scrolltop.min.js}"></script>
    <script th:src="@{/js/primevue/components/scrollpanel.min.js}"></script>

    <!-- flag-icons -->
    <link th:href="@{/css/flag-icons/css/flag-icons.css}" rel="stylesheet">

    <!-- basic js -->
    <script th:src="@{/js/basic/Data_Helper.js}"></script>

    <script th:src="@{/js/basic/Rakbow_Web_Url_Helper_Str.js}"></script>
    <script th:src="@{/js/basic/Rakbow_Web_Exception_Str_CN.js}"></script>

    <!--other css -->
    <link th:href="@{/css/global.css}" rel="stylesheet"/>
    <link th:href="@{/css/search.css}" rel="stylesheet"/>
    <link th:href="@{/css/item-index.css}" rel="stylesheet"/>
</head>
<body>
<div id="app">
    <!-- 头部 -->
    <header class="sticky-top mb-2" th:insert="~{template/header :: database_header}"></header>

    <div class="card">
        <div class="formgrid grid search">
            <div class="col">
                <p-inputtext id="globalSearch" v-model="searchParams.keyword" @keypress="search"
                             class="search-input"></p-inputtext>
            </div>
            <div class="col-2" style="margin: auto;">
                <p-dropdown v-model="searchParams.entityType" :options="entityType" option-label="label"
                            option-value="value" placeholder="类型">
                    <template #value="slotProps">
                        <div class="country-item country-item-value" v-if="slotProps.value">
                            <i :class="entityTypeValue2Icon(slotProps.value)"></i>
                            <span class="ml-1">{{entityTypeValue2Label(slotProps.value)}}</span>
                        </div>
                    </template>
                    <template #option="slotProps">
                        <div class="country-item">
                            <i :class="slotProps.option.icon"></i>
                            <span class="ml-1">{{slotProps.option.label}}</span>
                        </div>
                    </template>
                </p-dropdown>
            </div>
        </div>
        <div v-if="searchResult != null">
            <div v-if="searchResult.total != 0">
                <div class="text-start mt-3">
                    <span>共{{searchResult.total}}条结果</span>
                </div>
                <p-scrollpanel style="max-height: 500px">
                    <div v-if="searchResult.entityType == 1" v-for="result of searchResult.data">

                        <div class="col-12">
                            <div class="search-item">
                                <a class="text-center" :href="'/db/album/'+ result.id">
                                    <img :src="result.cover"/>
                                </a>
                                <div class="search-item-detail">
                                                    <span class="search-item-name text-truncate-1">
                                                        <a :href="'/db/album/'+ result.id">{{result.name}}</a>
                                                    </span>
                                    <span class="small-font" style="margin: 0 0 .5rem 0;">
                                                        <b class="label">{{result.catalogNo?result.catalogNo:'N/A'}}</b><span
                                            class="label">&nbsp{{result.releaseDate}}</span>
                                                    </span>
                                    <span class="ml-2">
                                                        <span class="has-bonus-tag" v-if="result.hasBonus">
                                                            <p-tag style="background: #1B273D" class="ml-1"
                                                                   value="特典"></p-tag>
                                                        </span>
                                                        <div v-for="format of result.albumFormat"
                                                             style="display:inline">
                                                            <p-tag class="product-tag ml-1"
                                                                   :value="format.label"></p-tag>
                                                        </div>
                                                    </span><br/>
                                    <span v-for="product of result.products" style="display:inline">
                                                        <a class="no-text-decoration"
                                                           :href="'/db/product/' + product.value">
                                                            <p-chip :label="product.label"></p-chip>
                                                        </a>
                                                    </span>
                                </div>
                            </div>
                        </div>
                        <p-divider></p-divider>
                    </div>
                    <div v-if="searchResult.entityType == 2" v-for="result of searchResult.data">
                        <div class="col-12">
                            <div class="search-item">
                                <a class="text-center" :href="'/db/disc/'+ result.id">
                                    <img :src="result.cover"/>
                                </a>
                                <div class="search-item-detail">
                                            <span class="search-item-name text-truncate-1">
                                                <a :href="'/db/disc/'+ result.id">{{result.name}}</a>
                                            </span>
                                    <span class="small-font" style="margin: 0 0 .5rem 0;">
                                                <b class="label">{{result.catalogNo?result.catalogNo:'N/A'}}</b><span
                                            class="label">&nbsp{{result.releaseDate}}</span>
                                            </span><br>
                                    <span :class="'fi fi-' + result.region.code" style="margin-left: 0.5rem"
                                          v-tooltip.bottom="{value: result.region.nameZh, class: 'region-tooltip'}">
                                            </span>
                                    <span>
                                                <span v-for="format of result.mediaFormat" style="display:inline">
                                                    <p-tag class="product-tag ml-1" :value="format.label"></p-tag>
                                                </span>
                                                <span class="has-bonus-tag" v-if="result.hasBonus">
                                                    <p-tag style="background: #1B273D" class="ml-1"
                                                           value="特典"></p-tag>
                                                </span>
                                                <span class="limited-tag" v-if="result.limited">
                                                    <p-tag style="background: #1B273D" class="ml-1"
                                                           value="限定"></p-tag>
                                                </span>
                                            </span>
                                </div>
                            </div>
                        </div>
                        <p-divider></p-divider>
                    </div>
                    <div v-if="searchResult.entityType == 3" v-for="result of searchResult.data">
                        <div class="col-12">
                            <div class="search-item">
                                <a class="text-center" :href="'/db/book/'+ result.id">
                                    <img :src="result.cover"/>
                                </a>
                                <div class="search-item-detail">
                                                    <span class="search-item-name text-truncate-1">
                                                        <a :href="'/db/book/'+ result.id">{{result.title}}</a>
                                                    </span>
                                    <span class="small-font" style="margin: 0 0 .5rem 0;">
                                                        <b class="label">{{result.isbn13}}</b><span class="label">&nbsp{{result.publishDate}}</span>
                                                    </span><br>
                                    <span :class="'fi fi-' + result.region.code" style="margin-left: 0.5rem"
                                          v-tooltip.bottom="{value: result.region.nameZh, class: 'region-tooltip'}"></span>
                                    &nbsp&nbsp<span class="label" style="font-size: 7px">{{result.publisher}}</span><br>
                                    <span>
                                                        <span class="p-1">
                                                            <p-tag :value="result.bookType.nameZh"></p-tag>
                                                        </span>
                                                        <span class="has-bonus-tag" v-if="result.hasBonus">
                                                            <p-tag style="background: #1B273D" class="ml-1"
                                                                   value="特典"></p-tag>
                                                        </span>
                                                    </span>
                                </div>
                            </div>
                        </div>
                        <p-divider></p-divider>
                    </div>
                    <div v-if="searchResult.entityType == 4" v-for="result of searchResult.data">
                        <div class="col-12">
                            <div class="search-item">
                                <a class="text-center" :href="'/db/merch/'+ result.id">
                                    <img :src="result.cover"/>
                                </a>
                                <div class="search-item-detail">
                                                    <span class="search-item-name text-truncate-1">
                                                        <a :href="'/db/merch/'+ result.id">{{result.name}}</a>
                                                    </span>
                                    <span class="small-font">
                                                        <span class="label">{{result.releaseDate}}</span>
                                                    </span>
                                    <span :class="'fi fi-' + result.region.code" style="margin-left: 0.5rem"
                                          v-tooltip.bottom="{value: result.region.nameZh, class: 'region-tooltip'}">
                                                    </span>
                                </div>
                            </div>
                        </div>
                        <p-divider></p-divider>
                    </div>
                    <div v-if="searchResult.entityType == 5" v-for="result of searchResult.data">
                        <div class="col-12">
                            <div class="search-item">
                                <a class="text-center" :href="'/db/game/'+ result.id">
                                    <img :src="result.cover"/>
                                </a>
                                <div class="search-item-detail">
                                                    <span class="search-item-name text-truncate-1">
                                                        <a :href="'/db/game/'+ result.id">{{result.name}}</a>
                                                    </span>
                                    <span class="small-font" style="margin: 0 0 .5rem 0;">
                                                        <span class="label">&nbsp{{result.releaseDate}}</span>
                                                    </span><br>
                                    <span :class="'fi fi-' + result.region.code" style="margin-left: 0.5rem"
                                          v-tooltip.bottom="{value: result.region.nameZh, class: 'region-tooltip'}">
                                                    </span>
                                    <span>
                                                        <span>
                                                            <p-tag class="ml-1" :value="result.platform.nameEn"></p-tag>
                                                        </span>
                                                        <span class="has-bonus-tag" v-if="result.hasBonus">
                                                            <p-tag style="background: #1B273D" class="ml-1"
                                                                   value="特典"></p-tag>
                                                        </span>
                                                    </span>
                                </div>
                            </div>
                        </div>
                        <p-divider></p-divider>
                    </div>
                    <p-scrolltop target="parent" :threshold="100" class="search-scrolltop"
                                 icon="pi pi-arrow-up"></p-scrolltop>
                </p-scrollpanel>
                <p-paginator
                        :template="{
                                    default: 'FirstPageLink PrevPageLink PageLinks NextPageLinLastPageLink LastPageLink JumpToPageDropdown'
                                    }"
                        v-model:first="searchResult.offset" :rows="searchResult.limit"
                        :total-records="searchResult.total" @page="pageChange($event)">
                </p-paginator>
            </div>
            <div v-else class="text-center mt-2">
                <img src="https://img.rakbow.com/common/icon/no-results.svg"/><br><span>暂无搜索结果</span>
            </div>
        </div>
    </div>

    <!-- 尾部 -->
    <footer class="mt-2" th:insert="~{template/footer :: site_footer}"></footer>
</div>
<script type="module" th:inline="javascript">

    import {postRequest} from '/js/basic/Http_Request.js';

    const {createApp, onMounted, watch, ref} = Vue;
    const Tooltip = primevue.tooltip;

    const App = {
        setup() {
            onMounted(() => {
            });

            const searchParams = ref({
                keyword: "",
                entityType: 0,
                offset: 0,
                limit: 10
            });
            const searchResult = ref();
            const entityType = ENTITY_TYPE;

            const search = () => {
                postRequest(null, INDEX_SEARCH_URL, searchParams.value)
                    .then(res => {
                        if (res.state === 1) {
                            searchResult.value = res.data;
                        }
                    });
            };
            const pageChange = (ev) => {
                searchParams.value.offset = ev.first;
                searchParams.value.limit = ev.rows;
                search();
            };

            return {
                NOT_LOGIN_NAVBAR_ITEMS, LOGIN_NAVBAR_ITEMS,
                entityTypeValue2Icon, entityTypeValue2Label, pageChange,
                search, entityType, searchResult, searchParams
            }
        },
        components: {
            "p-avatar": primevue.avatar,
            "p-inputtext": primevue.inputtext,
            "p-menubar": primevue.menubar,
            "p-dropdown": primevue.dropdown,
            "p-button": primevue.button,
            "p-divider": primevue.divider,
            "p-scrollpanel": primevue.scrollpanel,
            "p-chip": primevue.chip,
            "p-tag": primevue.tag,
            "p-scrolltop": primevue.scrolltop,
            "p-paginator": primevue.paginator,
        }
    };

    const routes = [{path: '/db', component: App}];

    const router = VueRouter.createRouter({
        history: VueRouter.createWebHistory(),
        routes
    });

    createApp(App)
        .use(router)
        .use(primevue.config.default)
        .directive('tooltip', Tooltip)
        .mount("#app");
</script>
<style>
</style>
</body>
</html>